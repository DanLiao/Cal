# Swift计算器 v2.0 使用说明

## 概述

Swift计算器 v2.0 是一个功能强大的命令行计算器，采用现代化模块化架构设计。相比 v1.0，新版本提供了更多功能、更好的性能和更强的可扩展性。

## 🆕 v2.0 新特性

### 核心功能增强
- **变量系统**: 支持定义和使用自定义变量
- **科学计数法**: 支持 `1.5e3`, `2E-4` 等格式
- **新增数学函数**: `abs`, `round`, `ceil`, `floor`, `factorial`, `log10`
- **更多常量**: 新增 `tau`, `golden` 等数学常量

### 架构优化
- **模块化设计**: 采用策略模式、命令模式等设计模式
- **性能提升**: 预编译正则表达式，优化字符串处理
- **错误处理**: 更精确的错误定位和描述
- **测试覆盖**: 完整的单元测试框架

## 🚀 快速开始

### 启动程序
```bash
# 使用 Swift Package Manager
swift run Cal

# 或者运行编译后的应用
./Cal.app/Contents/MacOS/Cal

# 带初始表达式启动
swift run Cal "2+3*4"
```

### 基本操作流程
1. 启动程序后会显示欢迎信息
2. 在 `>>` 提示符后输入表达式或命令
3. 按回车键执行
4. 输入 `quit` 或按 `Ctrl+C` 退出

## 📖 详细功能说明

### 1. 基本运算

支持标准数学运算符，遵循数学优先级：

```
>> 2 + 3 * 4        # 乘法优先: 14
>> (2 + 3) * 4      # 括号改变优先级: 20
>> 10 / 2 - 1       # 从左到右: 4
>> 2 ^ 3            # 幂运算: 8
```

**支持的运算符**:
- `+` 加法
- `-` 减法
- `*` 乘法
- `/` 除法
- `^` 幂运算
- `()` 括号（改变优先级）

### 2. 数学函数

所有函数都支持嵌套使用：

| 函数 | 描述 | 示例 | 结果 |
|------|------|------|------|
| `sqrt(x)` | 平方根 | `sqrt(16)` | 4 |
| `abs(x)` | 绝对值 | `abs(-5.3)` | 5.3 |
| `pow(x,y)` | x的y次方 | `pow(2,3)` | 8 |
| `log(x)` | 自然对数 | `log(e)` | 1 |
| `log10(x)` | 常用对数 | `log10(100)` | 2 |
| `sin(x)` | 正弦函数 | `sin(pi/2)` | 1 |
| `cos(x)` | 余弦函数 | `cos(0)` | 1 |
| `tan(x)` | 正切函数 | `tan(pi/4)` | 1 |
| `round(x)` | 四舍五入 | `round(3.7)` | 4 |
| `ceil(x)` | 向上取整 | `ceil(3.1)` | 4 |
| `floor(x)` | 向下取整 | `floor(3.9)` | 3 |
| `factorial(x)` | 阶乘 | `factorial(5)` | 120 |

**函数使用示例**:
```
>> sqrt(pow(3,2) + pow(4,2))    # 嵌套函数: 5
>> sin(pi/6)                    # 三角函数: 0.5
>> factorial(abs(-4))           # 组合使用: 24
```

### 3. 数学常量

系统预定义了常用数学常量：

| 常量 | 值 | 描述 |
|------|-----|------|
| `pi` | 3.14159... | 圆周率 |
| `e` | 2.71828... | 自然对数底 |
| `tau` | 6.28318... | 2π |
| `golden` | 1.61803... | 黄金比例 |

**使用示例**:
```
>> pi * 2                      # 使用π: 6.28318...
>> e ^ 2                       # 使用e: 7.38905...
>> sin(tau/4)                  # 使用τ: 1
```

### 4. 变量系统（新功能）

v2.0 支持定义和使用自定义变量：

#### 定义变量
```
>> let x = 5                   # 定义简单变量
>> let radius = 3.5            # 定义浮点数变量
>> let area = pi * radius^2    # 使用表达式定义变量
```

#### 使用变量
```
>> x * 2 + 1                   # 使用变量进行计算: 11
>> let y = x + 10              # 在新变量中使用已有变量
>> sqrt(x^2 + y^2)             # 复杂表达式中使用变量
```

#### 变量管理
```
>> vars                        # 显示所有已定义变量
>> let x = 10                  # 重新定义变量（覆盖原值）
```

### 5. 科学计数法（新功能）

支持多种科学计数法格式：

```
>> 1.5e3                       # 1500
>> 2E-4                        # 0.0002
>> 6.022e23                    # 阿伏伽德罗常数
>> 1.23e+5                     # 123000
```

### 6. 数字格式支持

支持多种数字输入格式：

```
>> 3.14                        # 标准小数
>> 2.                          # 无小数部分
>> .5                          # 无整数部分
>> 1,234.56                    # 千分位分隔符（自动处理）
```

### 7. 命令系统

#### 基本命令

| 命令 | 别名 | 功能 | 示例 |
|------|------|------|------|
| `help` | `h`, `?` | 显示帮助信息 | `help` |
| `quit` | `exit`, `q` | 退出程序 | `quit` |
| `clear` | `cls` | 清屏 | `clear` |
| `history` | - | 显示计算历史 | `history` |
| `record` | - | 保存历史到文件 | `record` |
| `ans` | - | 显示上次计算结果 | `ans` |
| `vars` | - | 显示所有变量 | `vars` |

#### 命令使用示例
```
>> 2 + 3                       # 计算: 5
>> ans * 2                     # 使用上次结果: 10
>> history                     # 查看历史记录
>> record                      # 保存到文件
>> vars                        # 查看所有变量
```

### 8. 历史记录管理

#### 查看历史
```
>> history                     # 显示最近50条记录
```

#### 保存历史
```
>> record                      # 保存到时间戳命名的文件
```

历史文件保存在 `record/` 目录下，格式为 `YYYYMMDD_HH.txt`。

#### 使用历史结果
```
>> 5 * 6                       # 计算: 30
>> ans + 10                    # 使用上次结果: 40
>> sqrt(ans)                   # 继续使用: 6.32...
```

## 💡 高级用法

### 1. 复杂表达式
```
>> let a = 3
>> let b = 4
>> let hypotenuse = sqrt(a^2 + b^2)
>> hypotenuse                  # 结果: 5
```

### 2. 函数链式调用
```
>> round(sqrt(abs(-16)))       # 嵌套函数: 4
>> factorial(ceil(3.2))        # 链式计算: 24
```

### 3. 科学计算
```
>> let c = 2.998e8             # 光速（m/s）
>> let f = 5e14                # 频率（Hz）
>> let wavelength = c/f        # 波长计算
>> wavelength * 1e9            # 转换为纳米
```

### 4. 三角函数计算
```
>> let angle = pi/3            # 60度（弧度）
>> sin(angle)                  # 正弦值: 0.866...
>> cos(angle)                  # 余弦值: 0.5
>> tan(angle)                  # 正切值: 1.732...
```

## ⚠️ 注意事项

### 1. 输入格式
- 函数名区分大小写（全部小写）
- 括号必须配对
- 运算符前后可以有空格
- 变量名只能包含字母、数字和下划线，且以字母开头

### 2. 数值精度
- 使用 Double 类型，精度约为15-17位十进制数字
- 极大或极小数值可能产生精度误差
- 三角函数使用弧度制

### 3. 错误处理
- 除零操作会返回错误信息
- 无效函数参数（如负数开方）会报错
- 未定义变量使用会提示错误
- 语法错误会显示具体位置

### 4. 性能提示
- 历史记录最多保存50条
- 变量数量无限制，但建议合理使用
- 复杂嵌套表达式可能影响计算速度

## 🔧 故障排除

### 常见问题

1. **"无效字符"错误**
   - 检查是否使用了不支持的符号
   - 确认函数名拼写正确

2. **"括号不匹配"错误**
   - 检查每个开括号都有对应的闭括号
   - 确认括号嵌套正确

3. **"未定义变量"错误**
   - 使用 `vars` 命令查看已定义变量
   - 确认变量名拼写正确

4. **计算结果异常**
   - 检查运算符优先级
   - 使用括号明确计算顺序

### 获取帮助
- 在程序中输入 `help` 获取帮助信息
- 输入 `?` 显示快速帮助
- 查看源代码了解详细实现

## 📊 版本对比

| 特性 | v1.0 | v2.0 |
|------|------|------|
| 代码架构 | 单文件690行 | 模块化6文件 |
| 数学函数 | 6个 | 12个 |
| 数学常量 | 2个 | 4个 |
| 变量支持 | 仅ans | 完整变量系统 |
| 科学计数法 | 不支持 | 支持 |
| 错误处理 | 基础 | 详细位置信息 |
| 测试覆盖 | 无 | 完整单元测试 |
| 性能优化 | 无 | 正则缓存等优化 |

## 🎯 使用技巧

1. **快速运算**: 使用 `ans` 引用上次结果，避免重复输入
2. **变量复用**: 定义常用值为变量，提高计算效率
3. **历史查询**: 使用 `history` 回顾之前的计算
4. **批量保存**: 定期使用 `record` 保存重要计算结果
5. **函数嵌套**: 利用函数嵌套功能实现复杂计算
6. **科学记数**: 处理极大极小数值时使用科学计数法

---

**版本**: v2.0  
**更新日期**: 2025年  
**作者**: Swift Calculator Team

更多信息请参考项目 README.md 文件。